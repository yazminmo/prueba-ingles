<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Nivel de Inglés</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #0066cc;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #test-area {
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
        }
        #char-count, #time-left {
            font-size: 0.9em;
            color: #666;
        }
        .question {
            margin-top: 20px;
        }
        .options {
            display: flex;
            flex-direction: column;
        }
        .option {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prueba de Nivel de Inglés</h1>
        <div id="test-selection">
            <h2>Seleccione una prueba:</h2>
            <button onclick="startTest('writing')">Prueba de Escritura</button>
            <button onclick="startTest('listening')">Prueba de Escucha</button>
            <button onclick="startTest('speaking')">Prueba de Conversación</button>
            <button onclick="showResults()">Ver Resultados</button>
        </div>
        <div id="test-area"></div>
    </div>

    <script>
        // ... [Mantener todo el código JavaScript anterior para la prueba de escritura] ...

        // Nuevas variables y funciones para la prueba de escucha
        const listeningTests = [
            {
                audio: "https://example.com/audio1.mp3",
                questions: [
                    {
                        question: "What is the main topic of the conversation?",
                        options: ["Weather", "Work", "Family", "Hobbies"],
                        correctAnswer: 1
                    },
                    {
                        question: "How does the speaker feel about their job?",
                        options: ["Excited", "Neutral", "Frustrated", "Scared"],
                        correctAnswer: 0
                    }
                ]
            },
            {
                audio: "https://example.com/audio2.mp3",
                questions: [
                    {
                        question: "Where are the speakers planning to go?",
                        options: ["Beach", "Mountains", "City", "Countryside"],
                        correctAnswer: 2
                    },
                    {
                        question: "When are they planning their trip?",
                        options: ["Next week", "Next month", "Next year", "Tomorrow"],
                        correctAnswer: 1
                    }
                ]
            }
        ];

        let currentListeningTest = 0;
        let currentQuestion = 0;
        let playCount = 0;
        let listeningTimeLeft = 300; // 5 minutes
        let listeningTimer;
        let userAnswers = [];

        function startListeningTest() {
            currentListeningTest = 0;
            currentQuestion = 0;
            playCount = 0;
            userAnswers = [];
            nextListeningQuestion();
        }

        function nextListeningQuestion() {
            if (currentListeningTest >= listeningTests.length) {
                finishListeningTest();
                return;
            }

            const test = listeningTests[currentListeningTest];
            const testArea = document.getElementById('test-area');
            
            if (currentQuestion === 0) {
                // New audio, reset play count
                playCount = 0;
                listeningTimeLeft = 300;
                testArea.innerHTML = `
                    <h2>Prueba de Escucha - Audio ${currentListeningTest + 1}/${listeningTests.length}</h2>
                    <p id="time-left">Tiempo restante: 5:00</p>
                    <audio id="audio-player" src="${test.audio}"></audio>
                    <button onclick="playAudio()">Reproducir Audio</button>
                    <p id="play-count">Reproducciones: ${playCount}/2</p>
                `;
                startListeningTimer();
            } else {
                const question = test.questions[currentQuestion - 1];
                testArea.innerHTML += `
                    <div class="question">
                        <p>${question.question}</p>
                        <div class="options">
                            ${question.options.map((option, index) => `
                                <label class="option">
                                    <input type="radio" name="q${currentQuestion}" value="${index}">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (currentQuestion === test.questions.length) {
                testArea.innerHTML += '<button onclick="submitListeningAnswers()">Enviar Respuestas</button>';
            } else {
                testArea.innerHTML += '<button onclick="nextListeningQuestion()">Siguiente Pregunta</button>';
            }

            currentQuestion++;
        }

        function playAudio() {
            if (playCount < 2) {
                const audio = document.getElementById('audio-player');
                audio.play();
                playCount++;
                document.getElementById('play-count').textContent = `Reproducciones: ${playCount}/2`;
            } else {
                alert('Has alcanzado el límite de reproducciones.');
            }
        }

        function startListeningTimer() {
            clearInterval(listeningTimer);
            listeningTimer = setInterval(() => {
                listeningTimeLeft--;
                const minutes = Math.floor(listeningTimeLeft / 60);
                const seconds = listeningTimeLeft % 60;
                document.getElementById('time-left').textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (listeningTimeLeft <= 0) {
                    submitListeningAnswers();
                }
            }, 1000);
        }

        function submitListeningAnswers() {
            clearInterval(listeningTimer);
            const form = document.querySelector('#test-area');
            const answers = Array.from(form.querySelectorAll('input[type="radio"]:checked')).map(input => parseInt(input.value));
            userAnswers.push(...answers);
            
            currentListeningTest++;
            currentQuestion = 0;
            
            if (currentListeningTest < listeningTests.length) {
                nextListeningQuestion();
            } else {
                finishListeningTest();
            }
        }

        function finishListeningTest() {
            const testArea = document.getElementById('test-area');
            let correctAnswers = 0;
            userAnswers.forEach((answer, index) => {
                const testIndex = Math.floor(index / 2);
                const questionIndex = index % 2;
                if (answer === listeningTests[testIndex].questions[questionIndex].correctAnswer) {
                    correctAnswers++;
                }
            });
            
            const totalQuestions = listeningTests.reduce((sum, test) => sum + test.questions.length, 0);
            const score = (correctAnswers / totalQuestions) * 100;
            
            testArea.innerHTML = `
                <h2>Prueba de Escucha Completada</h2>
                <p>Has respondido correctamente ${correctAnswers} de ${totalQuestions} preguntas.</p>
                <p>Tu puntuación es: ${score.toFixed(2)}%</p>
                <button onclick="showResults()">Ver Resultados Completos</button>
            `;
        }

        function startTest(testType) {
            if (testType === 'writing') {
                startWritingTest();
            } else if (testType === 'listening') {
                startListeningTest();
            } else {
                const testArea = document.getElementById('test-area');
                testArea.innerHTML = `<h2>Prueba de ${testType}</h2><p>Esta prueba aún no está implementada.</p>`;
            }
        }

        // ... [Mantener las funciones existentes para la prueba de escritura y resultados] ...
    </script>
</body>
</html>
